"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i){if(Object.prototype.hasOwnProperty.call(i,r)){e[r]=i[r]}}}return e};var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}return function(t,i,r){if(i)e(t.prototype,i);if(r)e(t,r);return t}}();// @preserve
/*\

title: $:/plugins/felixhayashi/tiddlymap/js/ViewAbstraction
type: application/javascript
module-type: library

@preserve

\*/
var _EdgeType=require("$:/plugins/felixhayashi/tiddlymap/js/EdgeType");var _EdgeType2=_interopRequireDefault(_EdgeType);var _utils=require("$:/plugins/felixhayashi/tiddlymap/js/utils");var _utils2=_interopRequireDefault(_utils);var _environment=require("$:/plugins/felixhayashi/tiddlymap/js/lib/environment");var env=_interopRequireWildcard(_environment);var _exception=require("$:/plugins/felixhayashi/tiddlymap/js/exception");function _interopRequireWildcard(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var i in e){if(Object.prototype.hasOwnProperty.call(e,i))t[i]=e[i]}}t.default=e;return t}}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var ViewAbstraction=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};_classCallCheck(this,e);if(t instanceof e){return t}this._registerPaths(t);if(i.isCreate){if(!this.configTRef){var r=_utils2.default.getRandomLabel({plural:true});this.configTRef=$tw.wiki.generateNewTitle($tm.path.views+"/"+r)}this._createView(i)}else if(!e.exists(this.getRoot())){throw new ResourceNotFoundException("ViewAbstraction",t)}this._rebuildCache()}_createClass(e,[{key:"isLocked",value:function e(){return $tw.wiki.isShadowTiddler(this.configTRef)}},{key:"update",value:function e(t){var i=t.changedTiddlers;if(t[env.path.edgeTypes]||_utils2.default.hasKeyWithPrefix(i,this.getRoot())){this._rebuildCache();return true}return false}},{key:"addPlaceholder",value:function e(t){_utils2.default.cp(_utils2.default.getTiddler(t),this.snapshotTRef,true)}},{key:"exists",value:function t(){return e.exists(this)}},{key:"getRoot",value:function e(){return this.configTRef}},{key:"getCreationDate",value:function e(t){var i=$tw.wiki.getTiddler(this.configTRef).fields["created"];if(t){return i instanceof Date?$tw.utils.formatDateString(i,"DDth MMM YYYY"):""}return i}},{key:"getLabel",value:function e(){return _utils2.default.getBasename(this.configTRef)}},{key:"destroy",value:function e(){_utils2.default.deleteTiddlers(_utils2.default.getMatches("[prefix["+this.configTRef+"]]"))}},{key:"getOccurrences",value:function e(){var t="[regexp:text[<\\$(tiddlymap|tmap).*?view=."+this.getLabel()+"..*?>]]";return _utils2.default.getMatches(t)}},{key:"rename",value:function t(i){if(typeof i!=="string"){return false}if(_utils2.default.inArray("/",i)){$tm.notify('A view name must not contain any "/"');return false}var r=this.getLabel();var n=env.path.views+"/"+i;var a=this.getRoot();_utils2.default.mv(a,n,true);if($tm.config.sys.defaultView===r){_utils2.default.setEntry($tm.ref.sysUserConf,"defaultView",i)}if($tm.config.sys.liveTab.fallbackView===r){_utils2.default.setEntry($tm.ref.sysUserConf,"liveTab.fallbackView",i)}$tw.wiki.each(function(t,n){if(t.fields["tmap.open-view"]===r){_utils2.default.setField(n,"tmap.open-view",i);return}if(e.exists(n)){var a=new e(n);var l=a.getNodeData();for(var s in l){if(l[s]["open-view"]===r){l[s]["open-view"]=i}}a.saveNodeData(l)}});this._registerPaths(i);this._rebuildCache()}},{key:"isEnabled",value:function e(t){return _utils2.default.isTrue(this.getConfig(t),false)}},{key:"getConfig",value:function e(t,i){var r=void 0;if(!i&&this.config){r=this.config}else{var n=_utils2.default.getTiddler(this.configTRef).fields;r=_utils2.default.getPropertiesByPrefix(n,"config.")}var a=t&&_utils2.default.startsWith(t,"config.")?t:"config."+t;return t?r[a]:r}},{key:"setConfig",value:function e(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++){i[r]=arguments[r]}if(i[0]==null){return}if(i.length===1&&_typeof(i[0])==="object"){for(var n in i[0]){this.setConfig(n,i[0][n])}}else if(i.length===2&&typeof i[0]==="string"){var a=_utils2.default.getWithoutPrefix(i[0],"config.");var l=i[1];if(l===undefined){return}if(l===null){$tm.logger("debug","Removing config",a);delete this.config["config."+a]}else{if(a==="edge_type_namespace"){var s=l.match(/[^:]+/);l=s?s[0]:""}}$tm.logger("log","Setting config",a,l);this.config["config."+a]=l}else{throw new(Function.prototype.bind.apply(_exception.InvalidArgumentException,[null].concat(i)))}$tw.wiki.addTiddler(new $tw.Tiddler(_utils2.default.getTiddler(this.configTRef),this.config))}},{key:"isLiveView",value:function e(){return this.getLabel()===$tm.misc.liveViewLabel}},{key:"_isNodeIncludedById",value:function t(i){var r=$tw.utils.escapeRegExp(e._getNodeIdFilterPart(i));return this.getNodeFilter("raw").match(r)}},{key:"setNodeFilter",value:function e(t,i){t=t.replace(/[\n\r]/g," ");if(this.getNodeFilter("raw")===t){return}if(this.isLiveView()&&!i){$tm.notify("You must not change the live view's node filter!");return}_utils2.default.setField(this.nodeFilterTRef,"filter",t);$tm.logger("debug","Node filter set to",t);this.nodeFilter=this.getNodeFilter(null,true)}},{key:"setEdgeTypeFilter",value:function e(t){t=t.replace(/[\n\r]/g," ");if(this.getEdgeTypeFilter("raw")===t){return}_utils2.default.setField(this.edgeTypeFilterTRef,"filter",t);$tm.logger("debug","Edge filter set to",t);this.edgeTypeFilter=this.getEdgeTypeFilter(null,true)}},{key:"addNode",value:function t(i){if(!this._isNodeIncludedById(i)){var r=e._getNodeIdFilterPart(i);var n=" ";this.setNodeFilter(this.getNodeFilter("raw")+n+r);this.saveNodePosition(i)}}},{key:"removeNode",value:function t(i){if(!this._isNodeIncludedById(i)){return false}var r=e._getNodeIdFilterPart(i);var n=this.getNodeFilter("raw").replace(r,"");this.setNodeFilter(n);if(this.nodeData[i]){this.saveNodeData(i,null)}return true}},{key:"getEdgeTypeFilter",value:function e(t,i){var r=void 0;if(!i&&this.edgeTypeFilter){r=this.edgeTypeFilter}else{var n=$tm.indeces.allETy;var a=Object.keys(n);var l=$tw.wiki.getTiddler(this.edgeTypeFilterTRef);r={};r.raw=l&&l.fields.filter||"";r.pretty=_utils2.default.getPrettyFilter(r.raw);r.matches=_utils2.default.getEdgeTypeMatches(r.raw,n);r.whitelist=_utils2.default.getLookupTable(r.matches)}return t?r[t]:r}},{key:"isEdgeTypeVisible",value:function e(t){return _utils2.default.isEdgeTypeMatch(_EdgeType2.default.getInstance(t).id,this.edgeTypeFilter.raw)}},{key:"getNodeFilter",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var r=void 0;if(!i&&this.nodeFilter){r=this.nodeFilter}else{r=_utils2.default.makeHashMap();var n=$tw.wiki.getTiddler(this.nodeFilterTRef);r.raw=n&&n.fields.filter||"";r.pretty=_utils2.default.getPrettyFilter(r.raw);r.compiled=$tw.wiki.compileFilter(r.raw)}return t?r[t]:r}},{key:"getNodeData",value:function e(t,i){var r=!i&&this.nodeData?this.nodeData:_utils2.default.parseFieldData(this.mapTRef,"text",{});return t?r[t]:r}},{key:"equals",value:function t(i){return i===this||e.exists(i)&&new e(i).getRoot()===this.getRoot()}},{key:"saveNodeData",value:function e(){var t=this.getNodeData();for(var i=arguments.length,r=Array(i),n=0;n<i;n++){r[n]=arguments[n]}if(r.length===2){if(_typeof(r[1])==="object"){if(r[1]===null){delete t[r[0]]}else{t[r[0]]=Object.assign(t[r[0]]||{},r[1])}}}else if(r.length===1&&_typeof(r[0])==="object"){$tm.logger("log","Storing data in",this.mapTRef);Object.assign(t,r[0])}else{throw new(Function.prototype.bind.apply(_exception.InvalidArgumentException,[null].concat(r)))}_utils2.default.writeFieldData(this.mapTRef,"text",t,$tm.config.sys.jsonIndentation);this.nodeData=t}},{key:"saveNodePosition",value:function e(t){if(t.id&&t.x!=null&&t.y!=null){this.saveNodeData(t.id,{x:t.x,y:t.y})}}},{key:"saveNodePositions",value:function e(t){var i=this.nodeData;for(var r in t){i[r]=i[r]||{};i[r].x=t[r].x;i[r].y=t[r].y}this.saveNodeData(i)}},{key:"setCentralTopic",value:function e(t){this.setConfig("central-topic",t)}},{key:"saveNodeStyle",value:function e(t,i){var r=this.getNodeData(t)||{};var n={x:r.x,y:r.y};for(var a in r){delete r[a]}this.saveNodeData(t,_extends({},i,n))}},{key:"_registerPaths",value:function t(i,r){this.configTRef=e._getRootPath(i);this.mapTRef=this.configTRef+"/map";this.nodeFilterTRef=this.configTRef+"/filter/nodes";this.edgeTypeFilterTRef=this.configTRef+"/filter/edges";this.snapshotTRef=this.getRoot()+"/snapshot"}},{key:"_createView",value:function t(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=i.isForce,n=i.protoView,a=i.isHidden;if(e.exists(this)){if(!r){return}this.destroy()}if(e.exists(n)){_utils2.default.cp(new e(n).getRoot(),this.configTRef,true)}var l={title:this.configTRef,id:_utils2.default.genUUID()};if(!a){l[$tm.field.viewMarker]=true}$tw.wiki.addTiddler(new $tw.Tiddler(_utils2.default.getTiddler(this.configTRef),l));this.setEdgeTypeFilter(env.filter.defaultEdgeTypeFilter)}},{key:"_rebuildCache",value:function e(){this.config=this.getConfig(null,true);this.nodeData=this.getNodeData(null,true);this.nodeFilter=this.getNodeFilter(null,true);this.edgeTypeFilter=this.getEdgeTypeFilter(null,true)}}],[{key:"_getNodeIdFilterPart",value:function e(t){var i=(typeof t==="undefined"?"undefined":_typeof(t))==="object"?t.id:t;return"[field:tmap.id["+i+"]]"}},{key:"_getRootPath",value:function t(i){if(i instanceof e){return i.configTRef}if(i instanceof $tw.Tiddler){i=i.fields.title}if(typeof i==="string"){var r=_utils2.default.getWithoutPrefix(i,$tm.path.views+"/");if(r&&!_utils2.default.hasSubString(r,"/")){return $tm.path.views+"/"+r}}}},{key:"exists",value:function t(i){if(!i){return false}if(i instanceof e){i=i.configTRef}else{i=e._getRootPath(i)}return _utils2.default.tiddlerExists(i)}}]);return e}();exports.default=ViewAbstraction;
//# sourceMappingURL=./maps/felixhayashi/tiddlymap/js/graph/ViewAbstraction.js.map
