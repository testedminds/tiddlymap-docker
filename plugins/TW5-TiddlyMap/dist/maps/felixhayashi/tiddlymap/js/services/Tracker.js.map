{"version":3,"sources":["felixhayashi/tiddlymap/js/services/Tracker.js"],"names":["_utils","require","Tracker","fixer","_classCallCheck","this","wiki","$tw","logger","$tm","_createIndex","tById","idByT","each","tObj","tRef","_utils2","default","isSystemOrDraft","id","fields","genUUID","setField","tiddler","isForce","getTiddler","ResourceNotFoundException","title","getTiddlerRef"],"mappings":";;;;;;;;;;AAaA,GAAAA,QAAAC,QAAA,kRAOMC,oBAEJ,QAAAA,GAAYC,GAAOC,gBAAAC,KAAAH,EAEjBG,MAAKC,KAAOC,IAAID,IAChBD,MAAKG,OAASC,IAAID,MAVtBH,MAAAK,sEA8BI,GAAMC,GAAQN,KAAKM,QACnB,IAAMC,GAAQP,KAAKO,QAEnBP,MAAKC,KAAKO,KAAK,SAACC,EAAMC,GAEpB,GAAIC,QAAAC,QAAMC,gBAAgBJ,GAAO,CAC/B,OAIF,GAAIK,GAAKL,EAAKM,OAAO,UACrB,KAAKD,EAAI,CACPA,EAAKH,QAAAC,QAAMI,SACXL,SAAAC,QAAMK,SAASR,EAAM,UAfZK,GAGbR,EAAMC,GAAQG,CAgBZH,GAAMG,GAAQI,uCAIjBI,EAAAC,GAiBC,GAAMV,GAAOE,QAAAC,QAAMQ,WAAWF,EAE9B,KAAKT,EAAM,CACT,KAAM,IAAIY,2BAA0BH,GAGtC,GAAIJ,GAAKL,EAAKM,OAAO,UAErB,KAAKD,GAAMK,EAAS,CAClBL,EAAKH,QAAAC,QAAMI,SACXL,SAAAC,QAAMK,SAASR,EAAM,UAAWK,EAChCd,MAAKG,OAAO,OAAQ,sBAAuBM,EAAKM,OAAOO,OAXzDtB,KAAAM,MAAMG,GAAOA,EAAAM,OAAMK,KAiBnBpB,MAAKO,MAAME,EAAKM,OAAOO,OAASR,CAd9B,OAAAA,4CAQKX,GAkBP,MAAOH,MAAKO,MAAMI,QAAAC,QAAMW,cAAcL,iDAKtC,MAAOlB,MAAKO,mDAXd,MAAAP,MAAAM,+CAsBeQ,GAhBb,MAAAd,MAAOM,MAAKC,mCA0BDV","file":"../../../../../felixhayashi/tiddlymap/js/services/Tracker.js","sourcesContent":["// @preserve\n/*\\\n\ntitle: $:/plugins/felixhayashi/tiddlymap/js/services/tracker\ntype: application/javascript\nmodule-type: library\n\n@preserve\n\n\\*/\n\n/*** Imports *******************************************************/\n\nimport utils from '$:/plugins/felixhayashi/tiddlymap/js/utils';\n\n/***************************** CODE ********************************/\n\n/**\n *\n */\nclass Tracker {\n\n  constructor(fixer) {\n\n    this.wiki = $tw.wiki;\n    this.logger = $tm.logger;\n\n    this._createIndex();\n\n  }\n\n  /**\n   * TiddlyMap uses ids to reference tiddlers. This function creates\n   * a table that maps ids to tRefs and vice versa.\n   *\n   * Two indeces are added to the indeces chain:\n   * 1. tById – tiddler references by id\n   * 2. idByT – ids by tiddler references\n   *\n   * @param {Array<TiddlerReference>} [allTiddlers] - The tiddlers to\n   *     use as basis for this index. If not stated, all tiddlers in\n   *     the wiki are used.\n   */\n  _createIndex() {\n\n    const tById = this.tById = {}; // tiddlerById\n    const idByT = this.idByT = {}; // idByTiddler\n\n    this.wiki.each((tObj, tRef) => {\n\n      if (utils.isSystemOrDraft(tObj)) {\n        return;\n      }\n\n      // will create id if not present\n      let id = tObj.fields['tmap.id'];\n      if (!id) {\n        id = utils.genUUID();\n        utils.setField(tObj, 'tmap.id', id);\n      }\n\n      tById[id] = tRef; // tiddlerById\n      idByT[tRef] = id; // idByTiddler\n\n    });\n\n  }\n\n  /**\n   * This method will assign an id to an *existing* tiddler that does\n   * not already possess and id. Any assigned id will be registered\n   * at the id->tiddler index.\n   *\n   * @param {Tiddler} tiddler - The tiddler to assign the id to.\n   * @param {boolean} isForce - True if the id should be overridden,\n   *     false otherwise. Only works if the id field is not set to title.\n   *\n   * @return {Id} The assigned or retrieved id.\n   */\n  assignId(tiddler, isForce) {\n\n    // Note: always reload from store to avoid setting wrong ids on tiddler\n    // being in the role of from and to at the same time.\n    const tObj = utils.getTiddler(tiddler);\n\n    if (!tObj) {\n      throw new ResourceNotFoundException(tiddler);\n    }\n\n    let id = tObj.fields['tmap.id'];\n\n    if (!id || isForce) {\n      id = utils.genUUID();\n      utils.setField(tObj, 'tmap.id', id);\n      this.logger('info', 'Assigning new id to', tObj.fields.title);\n    }\n\n    // blindly update the index IN ANY CASE because tiddler may have\n    // an id but it is not indexed yet (e.g. because of renaming operation)\n    this.tById[id] = tObj.fields.title;\n    this.idByT[tObj.fields.title] = id;\n\n    return id;\n\n  }\n\n  /**\n   * @param {Tiddler} tiddler\n   * @return string\n   */\n  getIdByTiddler(tiddler) {\n\n    return this.idByT[utils.getTiddlerRef(tiddler)];\n\n  }\n\n  getIdsByTiddlers() {\n    return this.idByT;\n  }\n\n  getTiddlersByIds() {\n    return this.tById;\n  }\n\n  /**\n   * @param id\n   * @return {TiddlerReference} tiddler\n   */\n  getTiddlerById(id) {\n\n    return this.tById[id];\n\n  }\n\n}\n\n/*** Exports *******************************************************/\n\nexport default Tracker;\n"],"sourceRoot":"../../../../../../src/plugins"}